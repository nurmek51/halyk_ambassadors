<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–≤–∏—Å –∞–¥—Ä–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        input, button { padding: 10px; margin: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .suggestions { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; }
        .suggestion { padding: 8px; cursor: pointer; }
        .suggestion:hover { background: #e0e0e0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üá∞üáø –°–µ—Ä–≤–∏—Å –∞–¥—Ä–µ—Å–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</h1>

    <!-- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è -->
    <div class="section">
        <h3>üì± –ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –∏–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</h3>
        <button onclick="getMyLocation()">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        <div id="location-result"></div>
    </div>

    <!-- –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ -->
    <div class="section">
        <h3>üîç –ü–æ–∏—Å–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ –∞–¥—Ä–µ—Å—É</h3>
        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." style="width: 70%;">
        <button onclick="searchAddress()">–ü–æ–∏—Å–∫</button>
        <div id="search-result"></div>
    </div>

    <!-- –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç -->
    <div class="section">
        <h3>üí° –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∞–¥—Ä–µ—Å–æ–≤</h3>
        <input type="text" id="autocomplete-input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..."
               oninput="showSuggestions()" style="width: 70%;">
        <div id="suggestions" class="suggestions" style="display: none;"></div>
    </div>

    <!-- –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div class="section">
        <h3>üåê –ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º</h3>
        <input type="number" id="lat-input" placeholder="–®–∏—Ä–æ—Ç–∞" step="any">
        <input type="number" id="lon-input" placeholder="–î–æ–ª–≥–æ—Ç–∞" step="any">
        <button onclick="reverseGeocode()">–ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å</button>
        <div id="reverse-result"></div>
    </div>

    <script>
        const API_BASE = '';

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function getMyLocation() {
            const resultDiv = document.getElementById('location-result');

            if (!navigator.geolocation) {
                resultDiv.innerHTML = '<div class="error">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>';
                return;
            }

            resultDiv.innerHTML = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    fetch(`${API_BASE}/api/geolocation-address`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({latitude: lat, longitude: lon})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const addr = data.address;
                            resultDiv.innerHTML = `
                                <div class="success">
                                    <strong>–í–∞—à –∞–¥—Ä–µ—Å:</strong><br>
                                    üìç ${addr.display_name}<br>
                                    üè† ${addr.road || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}<br>
                                    üèôÔ∏è ${addr.city || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}, ${addr.region || ''}<br>
                                    üìÆ ${addr.postcode || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}<br>
                                    üåê ${lat.toFixed(6)}, ${lon.toFixed(6)}
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                        }
                    })
                    .catch(error => {
                        resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error}</div>`;
                    });
                },
                function(error) {
                    resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}</div>`;
                }
            );
        }

        // –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞
        function searchAddress() {
            const query = document.getElementById('search-input').value;
            const resultDiv = document.getElementById('search-result');

            if (!query.trim()) {
                resultDiv.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
                return;
            }

            fetch(`${API_BASE}/api/geocode`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query, limit: 5})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.locations.length > 0) {
                    let html = '<div class="success">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞:</div>';
                    data.locations.forEach((loc, index) => {
                        html += `
                            <div class="result">
                                <strong>${index + 1}. ${loc.name || loc.display_name}</strong><br>
                                üìç ${loc.display_name}<br>
                                üåê ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}<br>
                                üèôÔ∏è ${loc.city}, ${loc.region}
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="error">–ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error}</div>`;
            });
        }

        // –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç
        let suggestionTimeout;
        function showSuggestions() {
            const query = document.getElementById('autocomplete-input').value;
            const suggestionsDiv = document.getElementById('suggestions');

            clearTimeout(suggestionTimeout);

            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionTimeout = setTimeout(() => {
                fetch(`${API_BASE}/api/autocomplete?q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.suggestions.length > 0) {
                        let html = '';
                        data.suggestions.forEach(suggestion => {
                            html += `
                                <div class="suggestion" onclick="selectSuggestion('${suggestion.short_text}')">
                                    <strong>${suggestion.short_text}</strong><br>
                                    <small>${suggestion.city}, ${suggestion.region}</small>
                                </div>
                            `;
                        });
                        suggestionsDiv.innerHTML = html;
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }, 300);
        }

        function selectSuggestion(text) {
            document.getElementById('autocomplete-input').value = text;
            document.getElementById('suggestions').style.display = 'none';
        }

        // –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function reverseGeocode() {
            const lat = parseFloat(document.getElementById('lat-input').value);
            const lon = parseFloat(document.getElementById('lon-input').value);
            const resultDiv = document.getElementById('reverse-result');

            if (isNaN(lat) || isNaN(lon)) {
                resultDiv.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div>';
                return;
            }

            fetch(`${API_BASE}/api/reverse-geocode`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({latitude: lat, longitude: lon})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const addr = data.address;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>–ê–¥—Ä–µ—Å:</strong><br>
                            üìç ${addr.display_name}<br>
                            üè† ${addr.road || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}<br>
                            üèôÔ∏è ${addr.city || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}, ${addr.region || ''}<br>
                            üìÆ ${addr.postcode || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error}</div>`;
            });
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#autocomplete-input') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
    </script>
</body>
</html>
